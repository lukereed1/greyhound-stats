<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Today's Greyhound Races</title>
    <style>
        /* --- Basic Reset & Typography --- */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #fff;
            color: #000;
        }
        h1, h2, h3 {
            color: #000;
        }
        h1 { text-align: center; }
        h2 { margin-top: 20px; border-bottom: 2px solid #000; padding-bottom: 5px; }
        h3 {
            font-size: 1.1em;
            background-color: transparent;
            border-bottom: 1px solid #ccc;
            padding: 8px 0;
            margin-top: 20px;
        }

        /* --- Table Styles --- */
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
            font-size: 12px;
            background-color: #fff;
            box-shadow: none;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center; 
            white-space: nowrap;
        }
        /* Left align Dog Name column */
        td:nth-child(2) { text-align: left; }

        thead {
            background-color: #000;
            color: #fff;
        }
        tr:nth-child(even) {
            background-color: transparent;
        }

        /* --- Button Styles --- */
        #controls, #venue-tabs, #upcoming-controls { text-align: center; margin-bottom: 20px; }
        #controls button, #venue-tabs button, #upcoming-controls button {
            margin: 3px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid #000;
            background-color: #fff;
            color: #000;
            border-radius: 0;
            font-weight: normal;
        }
        #controls button.active, #venue-tabs button.active {
            background-color: #000;
            color: #fff;
        }

        #content p { text-align: center; font-size: 1.2em; }

        /* --- HARMONIZED COLOR PALETTE --- */
        
        /* 1. Rankings (Greens) */
        .top-1 { background-color: #28a745 !important; color: white; font-weight: bold; }
        .top-2 { background-color: #9fdfb0 !important; color: black; }
        .top-3 { background-color: #d4edda !important; color: black; }

        /* 2. Verdicts (New Column) */
        .verdict-very-strong { 
            background-color: #FFD700 !important; /* GOLD */
            color: #000; 
            font-weight: 900; 
            border: 2px solid #b89c00;
            text-transform: uppercase;
            font-size: 11px;
        }
        .verdict-strong { 
            background-color: #28a745 !important; /* GREEN */
            color: #fff; 
            font-weight: bold; 
            text-transform: uppercase;
            font-size: 11px;
        }
        .verdict-place { 
            background-color: #17a2b8 !important; /* BLUE */
            color: #fff; 
            font-weight: bold; 
            text-transform: uppercase;
            font-size: 11px;
        }

        /* 3. Comparisons (Vs Field) */
        .faster { color: #28a745; font-weight: bold; } /* Green Text */
        .slower { color: #dc3545; } /* Red Text */

        /* 4. Running Style & Box Pref */
        .style-early, .box-good { background-color: #d4edda !important; color: #155724; font-weight: bold; }
        .style-mid, .box-neutral { background-color: #fff3cd !important; color: #856404; }
        .style-close { background-color: #d1ecf1 !important; color: #0c5460; }
        .box-poor { background-color: #f8d7da !important; color: #721c24; }

        /* --- Utils --- */
        tbody tr.clickable-row { cursor: pointer; }
        .scratched-style { text-decoration: line-through; color: #888; background-color: #f0f0f0 !important; }
        
        /* --- Modal Styles --- */
        #info-button {
            display: inline-block;
            margin-left: 10px;
            padding: 2px 8px;
            font-size: 14px;
            background-color: #fff;
            border: 1px solid #000;
            border-radius: 0;
            cursor: pointer;
            vertical-align: middle;
        }
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto; 
            background-color: rgba(255, 255, 255, 0.8);
        }
        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 20px;
            border: 2px solid #000;
            width: 90%;
            max-width: 800px;
            border-radius: 0;
            position: relative;
            box-shadow: none;
            max-height: 85vh;
            overflow-y: auto;
        }
        .modal-content p { margin: 10px 0; font-size: 0.9em; line-height: 1.4; }
        .close-button {
            color: #000;
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <h1>Today's Greyhound Races <button id="info-button" onclick="openModal()">i</button></h1>
    
    <div id="controls">
        <button onclick="showUpcomingRaces()" class="active">Upcoming</button>
        <button onclick="switchJurisdiction('VIC')">VIC</button><button onclick="switchJurisdiction('NSW')">NSW</button><button onclick="switchJurisdiction('QLD')">QLD</button><button onclick="switchJurisdiction('SA')">SA</button><button onclick="switchJurisdiction('WA')">WA</button><button onclick="switchJurisdiction('TAS')">TAS</button><button onclick="switchJurisdiction('ACT')">ACT</button><button onclick="switchJurisdiction('NT')">NT</button><button onclick="switchJurisdiction('NZ')">NZ</button>
    </div>
    
    <div id="content">
        <div id="venue-tabs"></div>
        <div id="meeting-content"><p>Loading all races for today, please wait...</p></div>
    </div>

    <!-- The Information Modal -->
    <div id="info-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h3>Statistic Explanations</h3>
            <p><strong>Verdict (AI):</strong> Classified based on dominance (Min 4 career starts).</p>
            <ul>
                <li><strong>VERY STRONG:</strong> Win > 30% AND Faster than Field AND Place > 60%. (Max 1 per race).</li>
                <li><em>Sorted by Dominance Score: (Win% + 0.5*TrackWin%) + Speed Bonus (75pts per sec).</em></li>
                <li><strong>STRONG:</strong> Win > 20% (Overall) OR > 25% (Track/Dist) AND Faster than Field. (Max 1 per race).</li>
                <li><strong>PLACE:</strong> > 50% Place Rate in Overall OR Track OR Distance categories. (Max 2 per race).</li>
            </ul>
            <hr>
            <p><strong>Class:</strong> Shows the grade change from the dog's last start to today's race. A dog moving from a higher to a lower number (e.g., 5â†’4) is dropping down in class, which can be a significant advantage.</p>
            <p><strong>Running Style:</strong> Classifies dogs as Early (frontrunners who lead from the start), Mid (take lead after first bend), or Close (finishers who come from behind). Early pace dogs win ~35% of races.</p>
            <p><strong>Box Pref:</strong> Indicates how this box draw suits the dog's historical performance. Green (Good) = running from their best-performing box group, Yellow (Neutral) = acceptable, Red (Poor) = running from a box group where they perform significantly worse.</p>
            <p><strong>Box Bias %:</strong> The historical win percentage for all greyhounds starting from this specific box at this specific track.</p>
            <p><strong>Lead @ 1st %:</strong> The percentage of races where this dog leads at the first bend. Higher percentages indicate strong early speed.</p>
            <p><strong>Trainer %:</strong> The trainer's win strike-rate from all recorded starts in the database.</p>
            <p><strong>Total Runs:</strong> The dog's total number of career starts.</p>
            <p><strong>Win % / Place %:</strong> The dog's overall career win and place (top 3) percentages.</p>
            <p><strong>Trk/Dist Exp:</strong> The number of previous starts this dog has had at this specific track (`Trk Exp`) and over this specific distance (`Dist Exp`). A higher number indicates more experience with the conditions.</p>
            <p><strong>Win/Place @ Track:</strong> Win and place percentages specifically at this track (requires 3+ starts). More relevant than overall career stats.</p>
            <p><strong>Win/Place @ Dist:</strong> Win and place percentages at this specific distance regardless of track.</p>
            <p><strong>Consistency:</strong> A score (0-100) indicating how reliably a dog performs over its entire career, calculated from statistical variation of race times. High score (99+) = very consistent.</p>
            <p><strong>Perf Score L5:</strong> A normalized speed rating (0-100+) focusing on the dog's last 5 starts. Calculated by comparing each race time to the fastest-ever time at that track/distance. Score of 100 equals the benchmark.</p>
            <p><strong>Avg T/D L5:</strong> The dog's average time over its last 5 starts at this specific Track and Distance.</p>
            <p><strong>Avg T/D vs Field:</strong> Compares the dog's "Avg T/D L5" to the average of all other active runners in this race. Negative green number = faster than field average.</p>
            <p><strong>Avg Spl L5:</strong> The dog's average first split time over its last 5 starts at this specific Track and Distance.</p>
            <p><strong>Avg Spl vs Field:</strong> Compares the dog's "Avg Spl L5" to the average of all other active runners in this race. Negative green number = faster early speed than the field.</p>
        </div>
    </div>

    <script>
        const contentDiv = document.getElementById('content');
        const venueTabsDiv = document.getElementById('venue-tabs');
        const meetingContentDiv = document.getElementById('meeting-content');
        const infoModal = document.getElementById('info-modal');
        let allRacesData = {};

        function openModal() { infoModal.style.display = 'block'; }
        function closeModal() { infoModal.style.display = 'none'; }
        window.onclick = function(event) {
            if (event.target == infoModal) closeModal();
        }

        const formatTime = (isoString) => {
             if (!isoString) return 'N/A';
             return new Date(isoString).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        };

        function processRaceData(race) {
            if (!race || !race.runs) return [];
            const activeRunners = race.runs.filter(r => !r.scratched && !r.isManuallyScratched && r.boxNumber);
            let totalAvgTime = 0, countAvgTime = 0, totalAvgSplit = 0, countAvgSplit = 0;
            activeRunners.forEach(runner => {
                if (runner.avgTimeLast5TrackDist) { totalAvgTime += runner.avgTimeLast5TrackDist; countAvgTime++; }
                if (runner.avgSplitLast5TrackDist) { totalAvgSplit += runner.avgSplitLast5TrackDist; countAvgSplit++; }
            });
            const fieldAvgTime = countAvgTime > 0 ? totalAvgTime / countAvgTime : null;
            const fieldAvgSplit = countAvgSplit > 0 ? totalAvgSplit / countAvgSplit : null;
            
            // Standard Rankings Logic
            const statsToRank = [
                { key: 'winRateAtTrack', higherIsBetter: true }, { key: 'placeRateAtTrack', higherIsBetter: true },
                { key: 'winRateAtDistance', higherIsBetter: true }, { key: 'placeRateAtDistance', higherIsBetter: true },
                { key: 'leadAtFirstBendRate', higherIsBetter: true }, { key: 'winRate', higherIsBetter: true },
                { key: 'placeRate', higherIsBetter: true }, { key: 'trainerStrikeRate', higherIsBetter: true },
                { key: 'boxWinPercentage', higherIsBetter: true }, { key: 'last5PerformanceScore', higherIsBetter: true },
                { key: 'consistencyScore', higherIsBetter: true }, { key: 'avgTimeLast5TrackDist', higherIsBetter: false },
                { key: 'avgSplitLast5TrackDist', higherIsBetter: false },
            ];
            
            race.runs.forEach(r => { 
                r.rankings = {}; 
                // Initialize Verdicts
                r.verdict = "";
                r.verdictClass = "";
            });

            statsToRank.forEach(stat => {
                const sortedRunners = activeRunners
                    .filter(r => r[stat.key] !== null && r[stat.key] !== undefined && r[stat.key] > 0)
                    .sort((a, b) => stat.higherIsBetter ? b[stat.key] - a[stat.key] : a[stat.key] - b[stat.key]);
                sortedRunners.slice(0, 3).forEach((runner, index) => { runner.rankings[stat.key] = index + 1; });
            });

            // Pre-calculate vs Field for all
            race.runs.forEach(runner => {
                if (!runner.scratched && !runner.isManuallyScratched && runner.boxNumber) {
                    runner.avgTdVsField = (runner.avgTimeLast5TrackDist && fieldAvgTime) ? runner.avgTimeLast5TrackDist - fieldAvgTime : undefined;
                    runner.avgSplitVsField = (runner.avgSplitLast5TrackDist && fieldAvgSplit) ? runner.avgSplitLast5TrackDist - fieldAvgSplit : undefined;
                } else {
                    runner.avgTdVsField = undefined;
                    runner.avgSplitVsField = undefined;
                }
            });
            
            // --- STRICT VERDICT LOGIC START ---

            // 1. Gather Eligible Candidates (Must have 4+ starts)
            let eligibleRunners = activeRunners.filter(r => (r.totalStarts || 0) >= 4);

            // 2. IDENTIFY "VERY STRONG"
            let veryStrongCandidates = eligibleRunners.filter(r => {
                const winPct = (r.winRate || 0) * 100;
                const placePct = (r.placeRate || 0) * 100;
                const vsField = r.avgTdVsField !== undefined ? r.avgTdVsField : 99; 
                
                if (placePct < 60) return false; 

                if (winPct > 30) return true; 
                if (winPct > 20 && vsField <= 0.05) return true; 

                return false;
            });

            veryStrongCandidates.sort((a, b) => {
                const winA = (a.winRate || 0) * 100;
                const trkA = (a.winRateAtTrack || 0) * 100;
                const speedA = a.avgTdVsField; 

                const winB = (b.winRate || 0) * 100;
                const trkB = (b.winRateAtTrack || 0) * 100;
                const speedB = b.avgTdVsField; 

                let scoreA = winA + (trkA * 0.5);
                let scoreB = winB + (trkB * 0.5);

                if (speedA !== undefined && speedB !== undefined) {
                    scoreA += (speedA * -1 * 75);
                    scoreB += (speedB * -1 * 75);
                }

                return scoreB - scoreA; 
            });
            
            if (veryStrongCandidates.length > 0) {
                const topDog = veryStrongCandidates[0];
                topDog.verdict = "VERY STRONG";
                topDog.verdictClass = "verdict-very-strong";
                eligibleRunners = eligibleRunners.filter(r => r.dogId !== topDog.dogId);
            }

            // 3. IDENTIFY "STRONG" (Max 1, Unified Label)
            let strongPotential = [];

            eligibleRunners.forEach(r => {
                const vsField = r.avgTdVsField !== undefined ? r.avgTdVsField : 99;
                const winPct = (r.winRate || 0) * 100;
                
                let timePasses = (vsField <= 0.05) || (winPct > 30);

                if (timePasses) {
                    const trackWinPct = (r.winRateAtTrack || 0) * 100;
                    const distWinPct = (r.winRateAtDistance || 0) * 100;
                    
                    const trkRuns = r.startsAtTrack || 0;
                    const distRuns = r.startsAtDistance || 0;

                    let highestScore = 0;
                    let qualifies = false;

                    // Overall Win > 20%
                    if (winPct > 20) {
                        highestScore = Math.max(highestScore, winPct);
                        qualifies = true;
                    }

                    // Track Win > 25% (min 4 runs)
                    if (trackWinPct > 25 && trkRuns >= 4) {
                        highestScore = Math.max(highestScore, trackWinPct);
                        qualifies = true;
                    }

                    // Dist Win > 25% (min 4 runs)
                    if (distWinPct > 25 && distRuns >= 4) {
                        highestScore = Math.max(highestScore, distWinPct);
                        qualifies = true;
                    }

                    if (qualifies) {
                        let speedBonus = 0;
                        if (vsField !== undefined && vsField !== 99) {
                            speedBonus = (vsField * -1 * 75);
                        }
                        
                        strongPotential.push({ 
                            runner: r, 
                            // Unified label "STRONG"
                            score: highestScore + speedBonus 
                        });
                    }
                }
            });

            strongPotential.sort((a, b) => b.score - a.score);
            
            let strongCount = 0;
            
            for (const potential of strongPotential) {
                if (strongCount >= 1) break; // Max 1 Strong

                potential.runner.verdict = "STRONG";
                potential.runner.verdictClass = "verdict-strong";
                
                strongCount++;
                eligibleRunners = eligibleRunners.filter(r => r.dogId !== potential.runner.dogId);
            }

            // 4. IDENTIFY "PLACE" (Max 2, Unified Label)
            let placePotential = [];

            eligibleRunners.forEach(r => {
                const placePct = (r.placeRate || 0) * 100;
                const trkPlacePct = (r.placeRateAtTrack || 0) * 100;
                const distPlacePct = (r.placeRateAtDistance || 0) * 100;

                const trkRuns = r.startsAtTrack || 0;
                const distRuns = r.startsAtDistance || 0;

                let qualifies = false;
                let highestScore = 0;

                if (placePct > 50) {
                    qualifies = true;
                    highestScore = Math.max(highestScore, placePct);
                }

                if (trkPlacePct > 50 && trkRuns >= 4) {
                    qualifies = true;
                    highestScore = Math.max(highestScore, trkPlacePct);
                }

                if (distPlacePct > 50 && distRuns >= 4) {
                    qualifies = true;
                    highestScore = Math.max(highestScore, distPlacePct);
                }

                if (qualifies) {
                    // Unified label "PLACE"
                    placePotential.push({ runner: r, score: highestScore });
                }
            });

            placePotential.sort((a, b) => b.score - a.score);

            let placeCount = 0;
            
            for (const potential of placePotential) {
                if (placeCount >= 2) break; // Max 2 Places

                potential.runner.verdict = "PLACE";
                potential.runner.verdictClass = "verdict-place";
                
                placeCount++;
            }

            // --- VERDICT LOGIC END ---

            return race.runs;
        }

        // REUSABLE FUNCTION to render a single race card
        function renderSingleRaceHTML(race, meeting, jurisdiction) {
            const runners = processRaceData(race).sort((a, b) => (a.boxNumber || 99) - (b.boxNumber || 99));
            return `
                <h3>${meeting.trackName} (${jurisdiction}) - Race ${race.raceNumber} (${formatTime(race.raceStart)}): ${race.name || 'Unnamed Race'} - ${race.distance}m</h3>
                <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Box</th> <th>Dog Name</th> <th>Last 5</th> <th>Class</th> <th>Style</th> <th>Box Pref</th> 
                            <th>Box Bias %</th> <th>Lead @ 1st %</th> <th>Trainer %</th> <th>Total Runs</th> <th>Win %</th> 
                            <th>Place %</th> <th>Trk Exp</th> <th>Win @ Track</th> <th>Place @ Track</th> <th>Dist Exp</th> 
                            <th>Win @ Dist</th> <th>Place @ Dist</th> <th>Consistency</th> <th>Perf Score L5</th> 
                            <th>Avg T/D L5</th> <th>Avg T/D vs Field</th> <th>Avg Spl L5</th> <th>Avg Spl vs Field</th>
                            <th>Verdict</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${runners.map(runner => {
                            const getHighlightClass = (statKey) => runner.rankings && runner.rankings[statKey] ? `top-${runner.rankings[statKey]}` : '';
                            const formatVsField = (value) => {
                                if (value === null || value === undefined) return 'N/A';
                                const className = value < 0 ? 'faster' : 'slower';
                                return `<span class="${className}">${value > 0 ? '+' : ''}${value.toFixed(3)}</span>`;
                            };
                            
                            const isPermScratched = runner.scratched || !runner.boxNumber;
                            const isVisuallyScratched = isPermScratched || runner.isManuallyScratched;
                            const rowClasses = [ isVisuallyScratched ? 'scratched-style' : '', !isPermScratched ? 'clickable-row' : '' ].join(' ');
                            const clickHandler = isPermScratched ? '' : `onclick="toggleScratch('${jurisdiction}', '${meeting.trackCode}', ${race.raceNumber}, ${runner.dogId})"`;
                            
                            const styleClass = runner.runningStyle === 'Early' ? 'style-early' : (runner.runningStyle === 'Mid' ? 'style-mid' : (runner.runningStyle === 'Close' ? 'style-close' : ''));
                            let boxPrefClass = '';
                            if (runner.boxPreference === 'Good') boxPrefClass = 'box-good';
                            else if (runner.boxPreference === 'Poor') boxPrefClass = 'box-poor';
                            else if (runner.boxPreference === 'Neutral') boxPrefClass = 'box-neutral';
                            
                            return `
                                <tr class="${rowClasses}" ${clickHandler}>
                                    <td>${runner.boxNumber || '-'}</td>
                                    <td>${runner.dogName}</td>
                                    <td>${runner.last5 || 'N/A'}</td>
                                    <td>${runner.classChange || 'N/A'}</td>
                                    <td class="${styleClass}">${runner.runningStyle || 'N/A'}</td>
                                    <td class="${boxPrefClass}">${runner.boxPreference || 'N/A'}</td>
                                    <td class="${getHighlightClass('boxWinPercentage')}">${runner.boxWinPercentage !== null ? (runner.boxWinPercentage * 100).toFixed(1) + '%' : 'N/A'}</td>
                                    <td class="${getHighlightClass('leadAtFirstBendRate')}">${runner.leadAtFirstBendRate !== null ? (runner.leadAtFirstBendRate * 100).toFixed(0) + '%' : 'N/A'}</td>
                                    <td class="${getHighlightClass('trainerStrikeRate')}">${runner.trainerStrikeRate !== null ? (runner.trainerStrikeRate * 100).toFixed(1) + '%' : 'N/A'}</td>
                                    <td>${runner.totalStarts ?? 'N/A'}</td>
                                    <td class="${getHighlightClass('winRate')}">${runner.winRate !== null ? (runner.winRate * 100).toFixed(1) + '%' : 'N/A'}</td>
                                    <td class="${getHighlightClass('placeRate')}">${runner.placeRate !== null ? (runner.placeRate * 100).toFixed(1) + '%' : 'N/A'}</td>
                                    <td>${runner.startsAtTrack ?? 'N/A'}</td>
                                    <td class="${getHighlightClass('winRateAtTrack')}">${runner.winRateAtTrack !== null ? (runner.winRateAtTrack * 100).toFixed(1) + '%' : 'N/A'}</td>
                                    <td class="${getHighlightClass('placeRateAtTrack')}">${runner.placeRateAtTrack !== null ? (runner.placeRateAtTrack * 100).toFixed(1) + '%' : 'N/A'}</td>
                                    <td>${runner.startsAtDistance ?? 'N/A'}</td>
                                    <td class="${getHighlightClass('winRateAtDistance')}">${runner.winRateAtDistance !== null ? (runner.winRateAtDistance * 100).toFixed(1) + '%' : 'N/A'}</td>
                                    <td class="${getHighlightClass('placeRateAtDistance')}">${runner.placeRateAtDistance !== null ? (runner.placeRateAtDistance * 100).toFixed(1) + '%' : 'N/A'}</td>
                                    <td class="${getHighlightClass('consistencyScore')}">${runner.consistencyScore ? runner.consistencyScore.toFixed(1) : 'N/A'}</td>
                                    <td class="${getHighlightClass('last5PerformanceScore')}">${runner.last5PerformanceScore ? runner.last5PerformanceScore.toFixed(1) : 'N/A'}</td>
                                    <td class="${getHighlightClass('avgTimeLast5TrackDist')}">${runner.avgTimeLast5TrackDist ? runner.avgTimeLast5TrackDist.toFixed(3) : 'N/A'}</td>
                                    <td>${formatVsField(runner.avgTdVsField)}</td>
                                    <td class="${getHighlightClass('avgSplitLast5TrackDist')}">${runner.avgSplitLast5TrackDist ? runner.avgSplitLast5TrackDist.toFixed(3) : 'N/A'}</td>
                                    <td>${formatVsField(runner.avgSplitVsField)}</td>
                                    <td class="${runner.verdictClass}">${runner.verdict || ''}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                </div>
            `;
        }

        function renderSingleMeetingHTML(meeting, jurisdiction) {
            if (!meeting) return `<p>Meeting data not found.</p>`;
            let html = `<h2>${meeting.trackName} (${meeting.trackCode})</h2>`;
            if (meeting.error) {
                html += `<p style="color: red;">${meeting.error}</p>`;
            } else if (meeting.races && meeting.races.length > 0) {
                html += meeting.races.map(race => renderSingleRaceHTML(race, meeting, jurisdiction)).join('');
            } else {
                 html += `<p>No races found for this meeting.</p>`;
            }
            return html;
        }
        
        function showUpcomingRaces() {
            document.querySelectorAll('#controls button').forEach(b => b.classList.toggle('active', b.textContent === 'Upcoming'));
            venueTabsDiv.style.display = 'none'; 

            const allFutureRaces = [];
            const now = new Date();

            for (const jur in allRacesData) {
                for (const meeting of allRacesData[jur]) {
                    if (meeting.races) {
                        for (const race of meeting.races) {
                            if (race.raceStart && new Date(race.raceStart) > now) {
                                allFutureRaces.push({
                                    jurisdiction: jur,
                                    meeting: meeting,
                                    race: race
                                });
                            }
                        }
                    }
                }
            }

            allFutureRaces.sort((a, b) => new Date(a.race.raceStart) - new Date(b.race.raceStart));

            const nextRaces = allFutureRaces.slice(0, 10);

            let html = `<div id="upcoming-controls">
                            <button onclick="showUpcomingRaces()">Refresh Upcoming Races</button>
                        </div>`;
            
            if (nextRaces.length === 0) {
                html += `<p>No upcoming races for today.</p>`;
                meetingContentDiv.innerHTML = html;
                return;
            }
            
            html += `<h2>Showing the Next ${nextRaces.length} Upcoming Races</h2>`;

            html += nextRaces.map(item => {
                return renderSingleRaceHTML(item.race, item.meeting, item.jurisdiction);
            }).join('');

            meetingContentDiv.innerHTML = html;
        }

        function toggleScratch(jurisdiction, trackCode, raceNumber, dogId) {
            try {
                const meeting = allRacesData[jurisdiction].find(m => m.trackCode === trackCode);
                const race = meeting.races.find(r => r.raceNumber === raceNumber);
                const runner = race.runs.find(run => run.dogId === dogId);
                runner.isManuallyScratched = !runner.isManuallyScratched;

                const isUpcomingView = document.querySelector('#controls button.active').textContent === 'Upcoming';
                if (isUpcomingView) {
                    showUpcomingRaces(); 
                } else {
                    switchVenue(jurisdiction, trackCode); 
                }
            } catch (e) { console.error("Could not toggle scratch state:", e); }
        }
        
        function switchVenue(jurisdiction, trackCode) {
            document.querySelectorAll('#venue-tabs button').forEach(b => b.classList.toggle('active', b.dataset.trackcode === trackCode));
            const meetingToShow = allRacesData[jurisdiction].find(m => m.trackCode === trackCode);
            meetingContentDiv.innerHTML = renderSingleMeetingHTML(meetingToShow, jurisdiction);
        }
        
        function switchJurisdiction(jurisdiction) {
            document.querySelectorAll('#controls button').forEach(b => b.classList.toggle('active', b.textContent === jurisdiction));
            venueTabsDiv.style.display = 'block'; 
            const meetings = allRacesData[jurisdiction];
            if (!meetings || meetings.length === 0) {
                venueTabsDiv.innerHTML = '';
                meetingContentDiv.innerHTML = `<p>No meetings found for this jurisdiction today.</p>`;
                return;
            }
            venueTabsDiv.innerHTML = meetings.map((m, i) => `<button class="${i === 0 ? 'active' : ''}" data-trackcode="${m.trackCode}" onclick="switchVenue('${jurisdiction}', '${m.trackCode}')">${m.trackCode}</button>`).join('');
            switchVenue(jurisdiction, meetings[0].trackCode);
        }
        
        async function loadAllRaces() {
            try {
                const response = await fetch(`/api/races/today/all`);
                if (!response.ok) { throw new Error(`Server returned status: ${response.status}`); }
                allRacesData = await response.json();
                showUpcomingRaces(); 
            } catch (error) {
                console.error('Failed to load all race data:', error);
                meetingContentDiv.innerHTML = `<p style="color: red;">Error: Could not fetch race data. Please check server console.</p>`;
            }
        }
        loadAllRaces();
    </script>
</body>
</html>